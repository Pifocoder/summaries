## Роли

Пользователи в ОС и в БД не одно и то же. Поэтому нужно уметь создавать пользователей в Постгрес и выдавать им роли. Роли бывают двух типов: пользователи и группы.

```sql
CREATE ROLE role_name;
DROP ROLE role_name;
```

Этих команд недостаточно. Нужно также выдать права доступа (почему-то они тоже называются роли). Какие бывают роли?

- *Superuser*. Самый крутой.
- *Login*. Логиниться.
- *Create DB*. Создавать БД.
- И многие другие.

```sql
CREATE ROLE andrey WITH LOGIN;
CREATE ROLE andrey WITH LOGIN PASSWORD 'password'
ALTER ROLE andrey WITH LOGIN;
ALTER ROLE andrey WITH NOLOGIN;
```

## Подключение пользователя

1. **Идентификация.** Определение роли в БД.
2. **Аутентификация.** Подтверждение того, что пользователь именно тот, за кого он себя выдает.
3. **Авторизация.** Имеет ли право данный пользователь подключаться к серверу.
ALTER ROLE andrey WITH LOGIN;

```bash
> psql -U andrey
FATAL: authentification failed
```

Настройка подключений осуществляется в файле о*pg_hba.conf*. Его можно посмотреть командой `SHOW hba_file`.

Подключаться к БД можно локально через соккеты (Unix-socket) и удалённо через сеть. При подключении по сети Постгрес не может самостоятельно установить имя пользователя ОС (по умолчанию он берёт его), поэтому его нужно указывать с помощью флага `-U`.

## Привелегии

**Привилегии** определяют, какие операции с объектами баз данных пользователь может выполнять. *Есть суперпользователи, владельцы объектов и остальные пользователи.*

Объект | Привилегии
-- | --
БД | CREATE, CONNECT
Схема | CREATE, USAGE
Таблица | SELECT, INSERT, UPDATE, REFERENCES, DELETE, TRUNCATE, TRIGGER
Представление | SELECT, TRIGGER
Последовательность | SELECT, UPDATE, USAGE

```sql
GRANT USAGE ON SCHEMA bookings TO andrey;
REVOKE USAGE ON SCHEMA bookings TO andrey; # забрать привилегию
GRANT SELECT ON bookings TO andrey;
```

Есть разница между выдачу привилегий на таблицу и схему. Схема - пространство имён, в котором лежат названия таблиц. Можно извлекать данные из `schema.database_name`.

- `\dn+` - привилегии схем.
- `\dp` - привилегии таблиц.

Можно выдать привилегии на представление какой-нибудь таблицы, вместо всей таблицы целиком.

```sql
ALTER SCHEMA boookings OWNER TO andrey;
```

### Политики защиты строк

- Row-level security, RLS.
- Fine Grained Access Control.

```sql
CREATE POLICY only_economy ON seats TO andrey USING (fare_conditions='Economy');
ALTER TABLE seats ENABLE ROW LEVEL SECURITY;
```

Созданием политик может заниматься либо суперпользователь, либо собственник объектов.

Если для пользователя назначена роль Bypass RLS, то для него политика защиты строк работать не будет.

## Примечания

- *LDAP*.
- *OAuth* - аутентификация через социальные сети или другие сервисы.
- Есть какая-то разница между атрибутами и привелегиями, но я не понял.