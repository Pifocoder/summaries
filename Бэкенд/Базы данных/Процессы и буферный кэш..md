## Буферный кэш.

>[!info] 
>Называется он так потому, что представляет собой массив буферов. Каждый буфер — это место под одну страницу данных (блок), плюс заголовок. Заголовок, в числе прочего, содержит:
> 
> -   расположение на диске страницы, находящейся в буфере (файл и номер блока в нем);
> -   признак того, что данные на странице изменились и рано или поздно должны быть записаны на диск (такой буфер называют грязным);
> -   число обращений к буферу (usage count);
> -   признак закрепления буфера (pin count).
> 
> Буферный кеш располагается в общей памяти сервера и доступен всем процессам. Чтобы работать с данными — читать или изменять, — процессы читают страницы в кеш. Пока страница находится в кеше, мы работаем с ней в оперативной памяти и экономим на обращениях к диску.
> 
> Источник: WAL в PostgreSQL: 1. Буферный кэш.

**Вытеснение из буферного кэша.** Есть фоновый процесс _background_writer_, который пробегается по буферам и очищает грязные.

По умолчанию размер кэша 128Мб. Базовая рекомендация по повышению производительности Postgre: увеличение буферного кэша. После изменения размера нужно перезагрузить Постгре.
```
sudo systemctl restart postgresql
```

## Процессы.

### Журналы предварительной записи

_Продолжение прошлой лекции._ Что делать, чтобы обеспечить сохранность данных при проблемах на сервере: поломках, задержках, выключении электричества и т.д.?

**Write Ahead Log (WAL).** Это журнал предзаписи. Может работать как синхронно, так и асинхронно. Асинхронный вариант быстрее, но может потерять данные.

Кажется, что записывать данные сначала в WAL, а потом на диск нецелесообразно, но в WAL данные пишутся последовательно, то есть без перехода к конкретному блоку памяти, за счёт этого загрузка данных происходит быстрее. И только после быстрой последовательной записи информация загружается уже в нужный блок БД.

После отказа запускается процесс восстановления. Он просматривает все сохранённые журналы предзаписи и применяет изменения. Незафиксированные транзакции откатываются.

**Контрольная точка.** Сохранение всех буферов из буферного кэша на диск. Тогда если скопилось много журналов, например, за неделю, можно не применять их все, а только те, которые были после контрольной точки.

Работает в фоновом режиме раз в установленный промежуток времени.

**Получить журнал предзаписи:**  
```
SELECT * FROM pg_ls_waldir();
```

### Репликация через журнал предзаписи

На отдельном сервере можно создать **stand_by** - рабочую версию базы данных, из которой можно только читать информацию. Тогда на ней можно запускать сложные аналитические запросы, которые не мешали бы работе основной БД.

### Фоновые процессы

-   **postmaster**. Основной процесс, управляющий остальными.
-   **startup**. Восстановление после сбоя.
-   **autovacuum**. Освобождение места в таблицах и индексах.
-   **val writer**. Запись на диск журналов предзаписи.
-   **checkpointer**. Выполнение контрольной точки.
-   **writer**. Запись грязных страниц на диск.

## Примечания

**Extensions** - расширения для PostgreSQL. Представлены обычным sql-файлом, можно создать свои. Для просмотра доступных расширений нужно выполнить `SELECT * FROM pg_available_extensions()`.

**Ссылки.**

-   [WAL в PostgreSQL: 1. Буферный кеш](https://habr.com/ru/companies/postgrespro/articles/458186/).

MADE by Valera